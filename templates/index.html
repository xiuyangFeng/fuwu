<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGFlow + Qwen æ™ºèƒ½é—®ç­”ç³»ç»Ÿ v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .left-panel, .right-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* ä¼˜åŒ–æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        /* ä¸ºä¸»é¢æ¿æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
        .left-panel::-webkit-scrollbar, .right-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track, .right-panel::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 4px;
        }

        .left-panel::-webkit-scrollbar-thumb, .right-panel::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 4px;
        }

        .left-panel::-webkit-scrollbar-thumb:hover, .right-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .status-bar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(222, 226, 230, 0.5);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: #28a745;
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }

        .status-dot.offline {
            background: #dc3545;
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        /* ä¸ºè¾“å…¥æ¡†æ·»åŠ æ›´å¥½çš„è§†è§‰åé¦ˆ */
        .form-input, .form-textarea, .form-select {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-input:hover, .form-textarea:hover, .form-select:hover {
            border-color: #8ca2ea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        /* ä¸ºå‚æ•°è¾“å…¥æ¡†æ·»åŠ ç‰¹æ®Šæ ·å¼æŒ‡ç¤ºå…¶è¢«æ™ºèƒ½ä¼˜åŒ– */
        .param-optimized {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%) !important;
            border-color: #28a745 !important;
            animation: optimized-glow 2s ease-in-out;
        }

        @keyframes optimized-glow {
            0%, 100% { box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1); }
            50% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0.2); }
        }

        /* æç¤ºè¯ç®¡ç†æ ·å¼ */
        .prompt-management {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .prompt-selector-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .prompt-selector-container select {
            flex: 1;
            background: white;
        }

        .btn-small {
            padding: 10px 16px;
            font-size: 0.85rem;
            white-space: nowrap;
            border-radius: 10px;
        }

        .prompt-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .prompt-preview-text {
            color: #666;
            font-style: italic;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .advanced-options {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .advanced-toggle {
            width: 100%;
            padding: 16px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
        }

        .advanced-toggle:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .advanced-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .advanced-content.show {
            max-height: 800px;
            padding: 20px;
            overflow-y: auto;
            /* æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        /* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
        .advanced-content.show::-webkit-scrollbar {
            width: 6px;
        }

        .advanced-content.show::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .advanced-content.show::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .advanced-content.show::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 12px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
            text-transform: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .btn-debug {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æµå¼è¾“å‡ºå…‰æ ‡åŠ¨ç”» */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .result-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .answer-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* ä¸“é—¨å¤„ç†é“¾æ¥æ˜¾ç¤ºçš„æ ·å¼ */
        .answer-text {
            line-height: 1.8;
            color: #333;
            font-size: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .answer-text a {
            color: #667eea;
            text-decoration: underline;
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
        }

        .answer-text a:hover {
            color: #5a6fd8;
            background-color: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        /* é•¿é“¾æ¥æ˜¾ç¤ºä¼˜åŒ– */
        .long-link {
            word-break: break-all;
            overflow-wrap: anywhere;
            hyphens: auto;
            line-height: 1.6;
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin: 8px 0;
            display: block;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        /* ===========================================
           äººç‰©ä¸»é¡µé“¾æ¥ä¸“å±æ ·å¼ - ç¾è§‚ä¼˜åŒ–
           =========================================== */
        
        /* äººç‰©é“¾æ¥å®¹å™¨ */
        .person-links-container {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .person-links-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
        }
        
        /* äººç‰©é“¾æ¥æ ‡é¢˜åŒºåŸŸ */
        .person-links-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .person-links-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }
        
        .person-links-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .person-links-count {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }
        
        /* äººç‰©é“¾æ¥åˆ—è¡¨ */
        .person-links-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* å•ä¸ªäººç‰©é“¾æ¥é¡¹ */
        .person-link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .person-link-item:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }
        
        /* äººç‰©ä¿¡æ¯åŒºåŸŸ */
        .person-link-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        
        .person-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 2px;
        }
        
        .person-domain {
            font-size: 12px;
            color: #666;
            padding: 2px 8px;
            background: #f1f3f4;
            border-radius: 12px;
            display: inline-block;
            font-family: 'Consolas', 'Monaco', monospace;
            max-width: fit-content;
        }
        
        /* äººç‰©é“¾æ¥æŒ‰é’® */
        .person-link-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        
        .person-link-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
            text-decoration: none;
        }
        
        .person-link-btn:active {
            transform: translateY(0);
        }
        
        .person-link-icon {
            font-size: 16px;
            animation: pulse 2s infinite;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* å·²ç§»é™¤åŸºäºURLå…³é”®è¯çš„æ ·å¼é€‰æ‹©å™¨ï¼Œç»Ÿä¸€ä½¿ç”¨ .enhanced-person-link ç±» */
        
        /* é’ˆå¯¹äººç‰©ä¸»é¡µé“¾æ¥çš„ç‰¹æ®Šæ ‡è¯† */
        .answer-text strong:contains("ç›¸å…³äººç‰©") {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
        }
        
        /* Enhanced Person Link æ ·å¼ (JavaScriptåŠ¨æ€æ·»åŠ ) */
        .enhanced-person-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            text-decoration: none !important;
            padding: 10px 20px !important;
            border-radius: 30px !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 10px !important;
            margin: 6px 4px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            font-size: 14px !important;
            border: none !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .enhanced-person-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .enhanced-person-link:hover::before {
            left: 100%;
        }
        
        .enhanced-person-link:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
            transform: translateY(-3px) scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
            color: white !important;
            text-decoration: none !important;
        }
        
        .enhanced-person-link:active {
            transform: translateY(-1px) scale(1.02) !important;
        }
        
        .person-link-icon {
            font-size: 18px !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
            animation: gentle-pulse 3s ease-in-out infinite;
        }
        
        @keyframes gentle-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* ç§»é™¤é‡å¤çš„Person Homepage Linkæ ·å¼ï¼Œç»Ÿä¸€ä½¿ç”¨enhanced-person-link */
        
        /* ä¼˜åŒ–äººç‰©ç›¸å…³æ–‡æœ¬çš„æ˜¾ç¤º */
        .answer-text hr + p strong:first-child,
        .answer-text hr + strong {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
            margin-right: 8px;
        }
        
        /* äººç‰©é“¾æ¥ä¸“å±åˆ†éš”çº¿æ ·å¼ */
        .answer-text hr {
            border: none;
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .answer-text hr::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        /* ç§»åŠ¨ç«¯äººç‰©é“¾æ¥ä¼˜åŒ– */
        @media (max-width: 768px) {
            .person-links-container {
                padding: 15px;
                margin: 15px 0;
            }
            
            .person-link-item {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .person-link-info {
                align-items: center;
                text-align: center;
            }
            
            .person-link-btn {
                width: 100%;
                justify-content: center;
                padding: 12px 20px;
            }
            
            .person-domain {
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
        
        /* è¶…å°å±å¹•äººç‰©é“¾æ¥ä¼˜åŒ– */
        @media (max-width: 480px) {
            .person-links-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .person-links-count {
                margin-left: 0;
            }
            
            .person-name {
                font-size: 14px;
            }
            
            .person-domain {
                font-size: 11px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* æç¤ºè¯ç®¡ç†å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.4s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 35px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }

        .close {
            color: white;
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 35px;
        }

        .template-list {
            margin-bottom: 30px;
        }

        .template-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid rgba(222, 226, 230, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .template-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-name {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }

        .template-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .template-content {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: #333;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .template-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small-action {
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-edit {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .template-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }

        .template-form h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .template-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-left: 10px;
            font-weight: 600;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                grid-template-columns: 1fr;
                gap: 15px;
                height: auto;
                max-width: 100%;
            }
            
            .left-panel, .right-panel {
                padding: 20px;
                border-radius: 15px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* ç§»åŠ¨ç«¯é«˜çº§é€‰é¡¹ä¼˜åŒ– */
            .advanced-content.show {
                max-height: 600px; /* ç§»åŠ¨ç«¯å‡å°é«˜åº¦ */
            }
            
            /* ç§»åŠ¨ç«¯æ™ºèƒ½æ£€ç´¢çŠ¶æ€ä¼˜åŒ– */
            #smartRetrievalStatus .btn {
                font-size: 12px;
                padding: 8px 12px;
                margin: 2px;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .btn {
                margin-right: 8px;
                margin-bottom: 8px;
                padding: 12px 20px;
                font-size: 13px;
            }
            
            /* ç§»åŠ¨ç«¯çŠ¶æ€æ ä¼˜åŒ– */
            .status-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            /* ç§»åŠ¨ç«¯é“¾æ¥æ˜¾ç¤ºä¼˜åŒ– */
            .long-link {
                font-size: 12px;
                padding: 8px;
                margin: 10px 0;
                word-break: break-all;
                overflow-wrap: anywhere;
            }
            
            .answer-text {
                font-size: 14px;
                line-height: 1.6;
            }
            
            .answer-text a {
                word-break: break-all;
                line-height: 1.4;
            }
            
            /* ç§»åŠ¨ç«¯æç¤ºè¯é€‰æ‹©å™¨ä¼˜åŒ– */
            .prompt-selector-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .prompt-selector-container select {
                margin-bottom: 8px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .main-container {
                padding: 0;
            }
            
            .left-panel, .right-panel {
                padding: 15px;
                margin: 5px;
                border-radius: 12px;
            }
            
            .title {
                font-size: 1.6rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            /* è¶…å°å±å¹•æŒ‰é’®ä¼˜åŒ– */
            .btn {
                width: 100%;
                margin: 4px 0;
                text-align: center;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ï¼šé—®ç­”ç•Œé¢ -->
        <div class="left-panel">
            <div class="header">
                <h1 class="title">RAGFlow + Qwen</h1>
                <p class="subtitle">æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>
                <span class="version-badge">v2.0 å¢å¼ºç‰ˆ</span>
            </div>

            <div class="status-bar">
                <div class="status-row">
                    <div class="status-indicator">
                        <div class="status-dot offline" id="statusDot"></div>
                        <span id="statusText">æ£€æŸ¥æœåŠ¡çŠ¶æ€ä¸­...</span>
                    </div>
                    <span id="responseTime" class="tooltip" data-tooltip="æœåŠ¡å“åº”æ—¶é—´">--ms</span>
                </div>
            </div>

            <form id="qaForm">
                <div class="form-group">
                    <label class="form-label" for="question">ğŸ¤” è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š</label>
                    <textarea 
                        id="question" 
                        name="question" 
                        class="form-textarea" 
                        placeholder="ä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯ç‰¹å¾å€¼ï¼ŸRAGFlowæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿè¯·è¯¦ç»†è§£é‡Š..."
                        required
                    ></textarea>
                </div>

                <!-- æç¤ºè¯ç®¡ç†åŒºåŸŸ -->
                <div class="prompt-management">
                    <div class="form-group">
                        <label class="form-label">ğŸ¯ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼š</label>
                        <div class="prompt-selector-container">
                            <select id="prompt_template" class="form-select">
                                <option value="default">é»˜è®¤æ¨¡æ¿</option>
                                <option value="detailed">è¯¦ç»†å›ç­”</option>
                                <option value="concise">ç®€æ´å›ç­”</option>
                                <option value="analytical">åˆ†æå›ç­”</option>
                            </select>
                            <button type="button" class="btn btn-small btn-secondary" onclick="showPromptManager()">
                                âš™ï¸ ç®¡ç†æ¨¡æ¿
                            </button>
                        </div>
                        <div class="prompt-preview" id="promptPreview">
                            <small class="prompt-preview-text">è¯·æ ¹æ®ä»¥ä¸‹èµ„æ–™å›ç­”ç”¨æˆ·é—®é¢˜ï¼š</small>
                        </div>
                    </div>
                </div>

                <div class="advanced-options">
                    <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
                        <span>âš™ï¸</span>
                        <span id="advancedToggleText">é«˜çº§é€‰é¡¹</span>
                        <span style="margin-left: auto;">â–¼</span>
                    </button>
                    <div class="advanced-content" id="advancedContent">
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="æ•°æ®é›†IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”">ğŸ“Š æ•°æ®é›†IDï¼š</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="dataset_ids" class="form-input" 
                                       value="" placeholder="åŠ è½½ä¸­..." readonly>
                                <button type="button" class="btn btn-small btn-secondary" onclick="refreshConfig()" title="åˆ·æ–°é…ç½®">
                                    ğŸ”„
                                </button>
                                <button type="button" class="btn btn-small btn-secondary" onclick="editDatasetIds()" title="ç¼–è¾‘æ•°æ®é›†ID">
                                    âœï¸
                                </button>
                            </div>
                            <small id="dataset_status" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                ğŸ’¡ ä».envæ–‡ä»¶è‡ªåŠ¨åŠ è½½ï¼Œç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½é…ç½®
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œè¶Šé«˜è¶Šä¸¥æ ¼">ğŸ¯ ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š</label>
                            <input type="number" id="similarity_threshold" class="form-input" 
                                   value="0.05" min="0" max="1" step="0.01">
                            <small id="threshold_hint" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                ğŸ’¡ æ™ºèƒ½æ£€ç´¢å°†æ ¹æ®é—®é¢˜ç±»å‹è‡ªåŠ¨ä¼˜åŒ–æ­¤å‚æ•°
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="æ£€ç´¢è¿”å›çš„æ–‡æ¡£æ•°é‡">ğŸ“š æ£€ç´¢æ–‡æ¡£æ•°ï¼š</label>
                            <input type="number" id="top_k" class="form-input" 
                                   value="15" min="1" max="100">
                            <small id="topk_hint" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                ğŸ’¡ è¯­ä¹‰é—®é¢˜å°†è‡ªåŠ¨å¢åŠ åˆ°20ä¸ªå€™é€‰
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="å‘é‡ç›¸ä¼¼åº¦æƒé‡">âš–ï¸ å‘é‡æƒé‡ï¼š</label>
                            <input type="number" id="vector_similarity_weight" class="form-input" 
                                   value="0.7" min="0" max="1" step="0.1">
                            <small id="weight_hint" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                ğŸ’¡ è¡Œä¸ºæŸ¥è¯¢å°†è‡ªåŠ¨è°ƒæ•´åˆ°0.8
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="æ§åˆ¶å›ç­”çš„åˆ›é€ æ€§ï¼Œè¶Šé«˜è¶Šæœ‰åˆ›æ„">ğŸŒ¡ï¸ Qwenæ¸©åº¦ï¼š</label>
                            <input type="number" id="temperature" class="form-input" 
                                   value="0.7" min="0" max="2" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label tooltip" data-tooltip="Qwenæœ€å¤§è¾“å‡ºtokenæ•°">ğŸ”¢ æœ€å¤§Tokenï¼š</label>
                            <input type="number" id="max_tokens" class="form-input" 
                                   value="2000" min="100" max="4000" step="100">
                        </div>
                    </div>
                </div>

                <!-- æ™ºèƒ½æ£€ç´¢çŠ¶æ€æ˜¾ç¤º -->
                <div id="smartRetrievalStatus" class="prompt-management" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">ğŸ¤– æ™ºèƒ½æ£€ç´¢çŠ¶æ€</strong>
                        <div style="float: right;">
                            <button type="button" class="btn btn-small btn-secondary" onclick="applyOptimizedParams()" id="applyParamsBtn" title="å°†ä¼˜åŒ–å‚æ•°åº”ç”¨åˆ°é…ç½®" style="display: none;">
                                âš¡ åº”ç”¨ä¼˜åŒ–
                            </button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="toggleSmartStatus()">
                                ğŸ“Š è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                    <div id="smartStatusDetails" style="display: none;">
                        <div style="background: white; border-radius: 8px; padding: 15px; font-size: 13px;">
                            <div><strong>é—®é¢˜ç±»å‹:</strong> <span id="questionType">-</span></div>
                            <div><strong>ä¼˜åŒ–é˜ˆå€¼:</strong> <span id="optimizedThreshold">-</span> 
                                <span id="thresholdChange" style="color: #28a745; font-size: 11px;"></span>
                            </div>
                            <div><strong>ä¼˜åŒ–TopK:</strong> <span id="optimizedTopK">-</span>
                                <span id="topkChange" style="color: #28a745; font-size: 11px;"></span>
                            </div>
                            <div><strong>ä¼˜åŒ–æƒé‡:</strong> <span id="optimizedWeight">-</span>
                                <span id="weightChange" style="color: #28a745; font-size: 11px;"></span>
                            </div>
                        </div>
                    </div>
                    <div id="smartStatusSummary">
                        <small id="smartStatusText" style="color: #666;">ç­‰å¾…é—®ç­”ä»¥æ˜¾ç¤ºæ™ºèƒ½ä¼˜åŒ–çŠ¶æ€...</small>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        ğŸš€ å¼€å§‹é—®ç­”
                    </button>
                    <button type="button" class="btn btn-primary" id="streamBtn" onclick="startStreamChat()">
                        âš¡ æµå¼é—®ç­”
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="cancelStreamChat()" style="display: none;">
                        â¸ï¸ æš‚åœå›ç­”
                    </button>
                    <button type="button" class="btn btn-debug" id="debugBtn" onclick="debugRagflow()">
                        ğŸ” è°ƒè¯•RAGFlow
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="testDataset()">
                        ğŸ§ª æµ‹è¯•æ•°æ®é›†
                    </button>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span id="loadingText">AIæ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç»“æœå±•ç¤º -->
        <div class="right-panel">
            <div class="result-section">
                <div class="result-tabs">
                    <button class="tab-btn active" onclick="switchTab('answer', event)">ğŸ’¬ AIå›ç­”</button>
                    <button class="tab-btn" onclick="switchTab('debug', event)">ğŸ”§ è°ƒè¯•ä¿¡æ¯</button>
                    <button class="tab-btn" onclick="switchTab('stats', event)">ğŸ“Š æ€§èƒ½ç»Ÿè®¡</button>
                </div>

                <!-- AIå›ç­”æ ‡ç­¾é¡µ -->
                <div id="answerTab" class="tab-content active">
                    <div id="answerContent" class="answer-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¤–</div>
                            <p>è¯·åœ¨å·¦ä¾§è¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯</p>
                        </div>
                    </div>
                </div>

                <!-- è°ƒè¯•ä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div id="debugTab" class="tab-content">
                    <div id="debugContent" class="answer-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”§</div>
                            <p>æš‚æ— è°ƒè¯•ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>

                <!-- æ€§èƒ½ç»Ÿè®¡æ ‡ç­¾é¡µ -->
                <div id="statsTab" class="tab-content">
                    <div id="performanceStats" class="answer-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“Š</div>
                            <p>æš‚æ— æ€§èƒ½ç»Ÿè®¡æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºè¯ç®¡ç†å¼¹çª— -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closePromptManager()">&times;</span>
                <h2 class="modal-title">ğŸ¯ æç¤ºè¯æ¨¡æ¿ç®¡ç†</h2>
            </div>
            <div class="modal-body">
                <div class="template-list" id="templateList">
                    <!-- æ¨¡æ¿åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="template-form">
                    <h3>ğŸ“ æ·»åŠ æ–°æ¨¡æ¿</h3>
                    <form id="newTemplateForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ¨¡æ¿åç§°ï¼š</label>
                                <input type="text" id="newTemplateName" class="form-input" placeholder="ä¾‹å¦‚ï¼šä¸“ä¸šè§£ç­”" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æè¿°ï¼š</label>
                                <input type="text" id="newTemplateDescription" class="form-input" placeholder="æ¨¡æ¿ç”¨é€”æè¿°">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¨¡æ¿å†…å®¹ï¼š</label>
                            <textarea id="newTemplateContent" class="form-textarea" rows="3" 
                                placeholder="ä¾‹å¦‚ï¼šè¯·ä½œä¸ºä¸“ä¸šé¡¾é—®ï¼Œæ ¹æ®ä»¥ä¸‹èµ„æ–™è¯¦ç»†å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œå¹¶æä¾›å®ç”¨å»ºè®®ï¼š" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isAdvancedVisible = false;
        let promptTemplates = {};
        
        // æµå¼è¯·æ±‚æ§åˆ¶
        let currentStreamController = null;
        let isStreamActive = false;
        let streamTimeoutMs = 320000; // é»˜è®¤320ç§’ï¼Œå°†ä»åç«¯åŠ¨æ€è·å–
        
        // é—®é¢˜åˆ†ææ§åˆ¶
        let analysisTimeout = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç³»ç»Ÿ...');
            
            // æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
            await checkHealth();
            
            // åŠ è½½é…ç½®ä¿¡æ¯
            await loadConfig();
            
            // åŠ è½½åç«¯è¶…æ—¶é…ç½®
            await loadBackendTimeout();
            
            // åŠ è½½æç¤ºè¯æ¨¡æ¿
            await loadPromptTemplates();
            
            // ç›‘å¬æç¤ºè¯æ¨¡æ¿é€‰æ‹©å˜åŒ–
            document.getElementById('prompt_template').addEventListener('change', updatePromptPreview);
            
            // ç›‘å¬é—®é¢˜è¾“å…¥å˜åŒ–ï¼Œå®æ—¶åˆ†æ
            document.getElementById('question').addEventListener('input', function(e) {
                const question = e.target.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(analysisTimeout);
                
                if (question.length >= 3) {
                    // å»¶è¿Ÿ500msååˆ†æï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                    analysisTimeout = setTimeout(async () => {
                        await analyzeQuestionType(question);
                    }, 500);
                } else {
                    // é—®é¢˜å¤ªçŸ­æ—¶éšè—æ™ºèƒ½æ£€ç´¢çŠ¶æ€
                    document.getElementById('smartRetrievalStatus').style.display = 'none';
                }
            });
            
            // è‡ªåŠ¨èšç„¦åˆ°é—®é¢˜è¾“å…¥æ¡†
            document.getElementById('question').focus();
        });

        // å¥åº·æ£€æŸ¥
        async function checkHealth() {
            try {
                updateStatus('offline', 'æ£€æŸ¥æœåŠ¡çŠ¶æ€ä¸­...');
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateStatus('online', 'æœåŠ¡åœ¨çº¿');
                    document.getElementById('responseTime').textContent = Math.round(data.response_time * 1000) + 'ms';
                } else {
                    updateStatus('offline', 'æœåŠ¡å¼‚å¸¸');
                }
            } catch (error) {
                updateStatus('offline', 'è¿æ¥å¤±è´¥');
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // åŠ è½½åç«¯è¶…æ—¶é…ç½®
        async function loadBackendTimeout() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                
                // è·å–Qwenæµå¼è¶…æ—¶é…ç½®ï¼ˆç§’è½¬æ¯«ç§’ï¼Œå¹¶å¢åŠ 20ç§’ç¼“å†²ï¼‰
                const qwenStreamTimeout = config.qwen?.stream_timeout || config.qwen?.timeout || 300;
                
                // ä½¿ç”¨æµå¼è¶…æ—¶ + 20ç§’ç¼“å†²ä½œä¸ºå‰ç«¯è¶…æ—¶
                streamTimeoutMs = (qwenStreamTimeout + 20) * 1000;
                
                console.log(`âœ… åŠ¨æ€åŠ è½½è¶…æ—¶é…ç½®: ${qwenStreamTimeout}s (åç«¯) + 20s (ç¼“å†²) = ${streamTimeoutMs/1000}s (å‰ç«¯)`);
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•åŠ è½½åç«¯è¶…æ—¶é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
                streamTimeoutMs = 320000; // é»˜è®¤320ç§’
            }
        }

        // é…ç½®ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                
                // æ›´æ–°æ•°æ®é›†IDæ˜¾ç¤º
                const datasetIdsInput = document.getElementById('dataset_ids');
                const datasetStatus = document.getElementById('dataset_status');
                
                if (config.datasets && config.datasets.default_dataset_ids) {
                    datasetIdsInput.value = config.datasets.default_dataset_ids.join(',');
                    datasetIdsInput.placeholder = '';
                    datasetStatus.innerHTML = `ğŸ’¡ å·²åŠ è½½${config.datasets.dataset_count}ä¸ªæ•°æ®é›†ID (æœ€åæ›´æ–°: ${formatTime(config.last_reload_time)})`;
                    datasetStatus.style.color = '#28a745';
                } else {
                    datasetIdsInput.value = '';
                    datasetIdsInput.placeholder = 'æœªé…ç½®æ•°æ®é›†ID';
                    datasetStatus.innerHTML = 'âš ï¸ æœªé…ç½®æ•°æ®é›†IDï¼Œè¯·æ£€æŸ¥.envæ–‡ä»¶';
                    datasetStatus.style.color = '#dc3545';
                }
                
                console.log('é…ç½®åŠ è½½æˆåŠŸ:', config);
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                const datasetStatus = document.getElementById('dataset_status');
                datasetStatus.innerHTML = 'âŒ é…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€';
                datasetStatus.style.color = '#dc3545';
            }
        }

        async function refreshConfig() {
            try {
                const refreshBtn = event.target;
                const originalText = refreshBtn.textContent;
                refreshBtn.textContent = 'â³';
                refreshBtn.disabled = true;
                
                const response = await fetch('/config/reload', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // é‡æ–°åŠ è½½é…ç½®æ˜¾ç¤º
                    await loadConfig();
                    
                    // æ˜¾ç¤ºåˆ·æ–°ç»“æœ
                    const datasetStatus = document.getElementById('dataset_status');
                    if (result.changes_detected) {
                        datasetStatus.innerHTML = `âœ… é…ç½®å·²åˆ·æ–°ï¼æ£€æµ‹åˆ°æ•°æ®é›†IDå˜æ›´: ${result.old_dataset_ids.join(',')} â†’ ${result.new_dataset_ids.join(',')}`;
                        datasetStatus.style.color = '#28a745';
                        
                        // æ˜¾ç¤ºæç¤º
                        alert(`é…ç½®åˆ·æ–°æˆåŠŸï¼\næ•°æ®é›†IDå·²æ›´æ–°ä¸º: ${result.new_dataset_ids.join(', ')}`);
                    } else {
                        datasetStatus.innerHTML = `âœ… é…ç½®å·²åˆ·æ–°ï¼Œæœªæ£€æµ‹åˆ°å˜æ›´ (${formatTime(result.reload_time)})`;
                        datasetStatus.style.color = '#17a2b8';
                    }
                } else {
                    alert('åˆ·æ–°é…ç½®å¤±è´¥: ' + result.detail);
                }
                
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            } catch (error) {
                console.error('åˆ·æ–°é…ç½®å¤±è´¥:', error);
                alert('åˆ·æ–°é…ç½®å¤±è´¥: ' + error.message);
                
                const refreshBtn = event.target;
                refreshBtn.textContent = 'ğŸ”„';
                refreshBtn.disabled = false;
            }
        }

        async function editDatasetIds() {
            try {
                const currentIds = document.getElementById('dataset_ids').value;
                const newIds = prompt('è¯·è¾“å…¥æ•°æ®é›†ID (å¤šä¸ªIDç”¨é€—å·åˆ†éš”):', currentIds);
                
                if (newIds !== null && newIds !== currentIds) {
                    const persistChoice = confirm('æ˜¯å¦å°†å˜æ›´ä¿å­˜åˆ°.envæ–‡ä»¶ä¸­ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ä¿å­˜åˆ°.envæ–‡ä»¶ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰\nç‚¹å‡»"å–æ¶ˆ"ä»…åœ¨å½“å‰ä¼šè¯ä¸­ç”Ÿæ•ˆ');
                    
                    const response = await fetch('/config/datasets', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            dataset_ids: newIds.split(',').map(id => id.trim()).filter(id => id),
                            persist: persistChoice
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // æ›´æ–°æ˜¾ç¤º
                        await loadConfig();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        let message = `æ•°æ®é›†IDæ›´æ–°æˆåŠŸï¼\n`;
                        message += `æ–°çš„ID: ${result.new_dataset_ids.join(', ')}\n`;
                        if (result.persisted) {
                            message += '\nâœ… å·²ä¿å­˜åˆ°.envæ–‡ä»¶ï¼Œé‡å¯åä»ç„¶æœ‰æ•ˆ';
                        } else if (persistChoice) {
                            message += '\nâš ï¸ ä¿å­˜åˆ°.envæ–‡ä»¶å¤±è´¥ï¼Œä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆ';
                        } else {
                            message += '\nğŸ’¡ ä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼Œé‡å¯åå°†æ¢å¤åŸé…ç½®';
                        }
                        
                        alert(message);
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + result.detail);
                    }
                }
            } catch (error) {
                console.error('ç¼–è¾‘æ•°æ®é›†IDå¤±è´¥:', error);
                alert('ç¼–è¾‘å¤±è´¥: ' + error.message);
            }
        }

        function formatTime(timeString) {
            if (!timeString) return 'æœªçŸ¥';
            try {
                const date = new Date(timeString);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return timeString;
            }
        }

        // åˆ‡æ¢é«˜çº§é€‰é¡¹
        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggleText = document.getElementById('advancedToggleText');
            const arrow = document.querySelector('.advanced-toggle span:last-child');
            
            isAdvancedVisible = !isAdvancedVisible;
            
            if (isAdvancedVisible) {
                content.classList.add('show');
                toggleText.textContent = 'æ”¶èµ·é«˜çº§é€‰é¡¹';
                arrow.textContent = 'â–²';
            } else {
                content.classList.remove('show');
                toggleText.textContent = 'é«˜çº§é€‰é¡¹';
                arrow.textContent = 'â–¼';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, event) {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // å¦‚æœæ²¡æœ‰eventï¼Œé€šè¿‡æŒ‰é’®æ–‡æœ¬æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach(btn => {
                    if (btn.onclick.toString().includes(tabName)) {
                        btn.classList.add('active');
                    }
                });
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // æ™ºèƒ½æ ¼å¼åŒ–ç­”æ¡ˆä¸­çš„é“¾æ¥ï¼ˆä¿®å¤ç‰ˆ - ç»Ÿä¸€ä¸ªäººä¸»é¡µé“¾æ¥æ ·å¼ï¼‰
        function formatAnswerWithLinks(answer) {
            if (!answer) return '';
            
            // é¦–å…ˆå¤„ç†Markdownæ ¼å¼çš„ä¸ªäººä¸»é¡µé“¾æ¥ï¼Œè¿™æ˜¯ä¸»è¦çš„ä¸ªäººä¸»é¡µé“¾æ¥æ ¼å¼
            // åŒ¹é…æ ¼å¼ï¼š[ç‚¹å‡»è®¿é—®{å§“å}çš„ä¸ªäººä¸»é¡µ](URL)
            const personHomepageMarkdownRegex = /\[ç‚¹å‡»è®¿é—®(.+?)çš„ä¸ªäººä¸»é¡µ\]\(([^)]+)\)/g;
            
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            let processedAnswer = answer
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            // ä¼˜å…ˆå¤„ç†Markdownæ ¼å¼çš„ä¸ªäººä¸»é¡µé“¾æ¥
            processedAnswer = processedAnswer.replace(personHomepageMarkdownRegex, function(match, personName, url) {
                const cleanUrl = url.trim();
                const cleanName = personName.trim();
                // æ ‡è®°ä¸ºä¸ªäººä¸»é¡µé“¾æ¥ï¼Œä¾¿äºåç»­ç»Ÿä¸€ç¾åŒ–å¤„ç†
                return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" data-person-link="true" data-person-name="${cleanName}">ç‚¹å‡»è®¿é—®${cleanName}çš„ä¸ªäººä¸»é¡µ</a>`;
            });
            
            // å¤„ç†æ¢è¡Œç¬¦
            processedAnswer = processedAnswer.replace(/\n/g, '<br>');
            
            // å¤„ç†å…¶ä»–æ™®é€šURLé“¾æ¥ï¼ˆä¸åŒ…æ‹¬ä¸ªäººä¸»é¡µé“¾æ¥ï¼‰
            const urlRegex = /https?:\/\/[^\s<>"\u4e00-\u9fa5()ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š'"'"ã€‹ã€Šï¼‰ï¼ˆ\]ã€‘\[ã€]+/gi;
            processedAnswer = processedAnswer.replace(urlRegex, function(url) {
                const cleanUrl = url.trim();
                
                // è·³è¿‡å·²ç»è¢«å¤„ç†çš„é“¾æ¥ï¼ˆé€šè¿‡æ£€æŸ¥å‰åæ–‡æ˜¯å¦å·²ç»æ˜¯<a>æ ‡ç­¾ï¼‰
                const beforeUrl = processedAnswer.substring(0, processedAnswer.indexOf(url));
                const afterUrl = processedAnswer.substring(processedAnswer.indexOf(url) + url.length);
                if (beforeUrl.endsWith('href="') || afterUrl.startsWith('">')) {
                    return url; // å·²ç»æ˜¯é“¾æ¥çš„ä¸€éƒ¨åˆ†ï¼Œè·³è¿‡å¤„ç†
                }
                
                if (cleanUrl.length > 50) {
                    // é•¿é“¾æ¥å¤„ç†
                    let displayUrl;
                    if (cleanUrl.length > 80) {
                        const domain = cleanUrl.match(/https?:\/\/([^\/]+)/);
                        const domainPart = domain ? domain[1] : cleanUrl.substring(8, 30);
                        displayUrl = `${domainPart}...`;
                    } else {
                        displayUrl = cleanUrl.substring(0, 50) + '...';
                    }
                    
                    return `<div class="long-link">
                        <a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»è®¿é—®: ${cleanUrl}">
                            ğŸ”— ${displayUrl}
                        </a>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">
                            å®Œæ•´é“¾æ¥: ${cleanUrl.length > 100 ? cleanUrl.substring(0, 100) + '...' : cleanUrl}
                        </div>
                    </div>`;
                } else {
                    // æ™®é€šçŸ­é“¾æ¥
                    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer">${cleanUrl}</a>`;
                }
            });
            
            return processedAnswer;
        }

        // ä¸“é—¨å¤„ç†äººç‰©ä¸»é¡µé“¾æ¥çš„ç¾åŒ–å‡½æ•°ï¼ˆç»Ÿä¸€ç‰ˆï¼‰
        function enhancePersonLinks(answerElement) {
            if (!answerElement) return;
            
            // åªæŸ¥æ‰¾è¢«æ ‡è®°ä¸ºä¸ªäººä¸»é¡µé“¾æ¥çš„å…ƒç´ 
            const personLinks = answerElement.querySelectorAll('a[data-person-link="true"]');
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºæ‰¾åˆ°çš„äººç‰©é“¾æ¥
            console.log(`å‘ç° ${personLinks.length} ä¸ªäººç‰©ä¸»é¡µé“¾æ¥:`, 
                Array.from(personLinks).map(link => ({
                    href: link.href,
                    text: link.textContent.substring(0, 50),
                    personName: link.dataset.personName || 'æœªçŸ¥'
                }))
            );
            
            personLinks.forEach(link => {
                // ç¡®ä¿æ‰€æœ‰äººç‰©é“¾æ¥éƒ½æœ‰ç»Ÿä¸€çš„æ ·å¼ç±»
                link.classList.add('enhanced-person-link');
                
                // ä»dataå±æ€§è·å–äººç‰©å§“å
                let personName = link.dataset.personName || '';
                
                // å¦‚æœæ²¡æœ‰data-person-nameå±æ€§ï¼Œä»é“¾æ¥æ–‡æœ¬ä¸­æå–
                if (!personName) {
                    const linkText = link.textContent.trim();
                    if (linkText.includes('ç‚¹å‡»è®¿é—®') && linkText.includes('çš„ä¸ªäººä¸»é¡µ')) {
                        const nameMatch = linkText.match(/ç‚¹å‡»è®¿é—®(.+?)çš„ä¸ªäººä¸»é¡µ/);
                        personName = nameMatch ? nameMatch[1].trim() : 'æŸæ•™å¸ˆ';
                    } else {
                        personName = 'æŸ¥çœ‹è¯¦æƒ…';
                    }
                }
                
                // ç»Ÿä¸€è®¾ç½®é“¾æ¥æ˜¾ç¤ºæ ¼å¼
                link.innerHTML = `<span class="person-link-icon">ğŸ‘¤</span>${personName}çš„ä¸»é¡µ`;
                
                // ç¡®ä¿é“¾æ¥æ ·å¼æ­£ç¡®
                link.style.textDecoration = 'none';
                
                // æ·»åŠ æ‚¬åœæ•ˆæœï¼ˆé¿å…é‡å¤æ·»åŠ äº‹ä»¶ï¼‰
                if (!link.hasAttribute('data-enhanced')) {
                    link.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px) scale(1.05)';
                    });
                    
                    link.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0) scale(1)';
                    });
                    
                    link.setAttribute('data-enhanced', 'true');
                }
            });
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show, text = 'AIæ­£åœ¨æ€è€ƒä¸­...', isStream = false) {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const submitBtn = document.getElementById('submitBtn');
            const streamBtn = document.getElementById('streamBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const debugBtn = document.getElementById('debugBtn');
            
            if (show) {
                loading.style.display = 'block';
                loadingText.textContent = text;
                submitBtn.disabled = true;
                streamBtn.disabled = true;
                debugBtn.disabled = true;
                
                // æ ¹æ®æ˜¯å¦ä¸ºæµå¼è¯·æ±‚æ˜¾ç¤º/éšè—å–æ¶ˆæŒ‰é’®
                if (isStream) {
                    cancelBtn.style.display = 'inline-block';
                    streamBtn.textContent = 'âš¡ ç”Ÿæˆä¸­...';
                } else {
                    cancelBtn.style.display = 'none';
                    submitBtn.textContent = 'ğŸ¤” æ€è€ƒä¸­...';
                }
            } else {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                streamBtn.disabled = false;
                debugBtn.disabled = false;
                cancelBtn.style.display = 'none';
                submitBtn.textContent = 'ğŸš€ å¼€å§‹é—®ç­”';
                streamBtn.textContent = 'âš¡ æµå¼é—®ç­”';
                
                // é‡ç½®æµå¼è¯·æ±‚çŠ¶æ€
                isStreamActive = false;
                currentStreamController = null;
            }
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer(data) {
            const answerContent = document.getElementById('answerContent');
            const debugContent = document.getElementById('debugContent');
            const statsContent = document.getElementById('performanceStats');
            
            // æ™ºèƒ½å¤„ç†é“¾æ¥å’Œæ–‡æœ¬
            const processedAnswer = formatAnswerWithLinks(data.answer);
            
            // æ˜¾ç¤ºAIå›ç­”
            answerContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #667eea;">ğŸ¤– AIå›ç­”ï¼š</strong>
                </div>
                <div class="answer-text">
                    ${processedAnswer}
                </div>
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666;">
                    <div>ğŸ“Š ä½¿ç”¨æ–‡æ¡£: ${data.ragflow_docs_count} ä¸ª</div>
                    <div>ğŸ¯ æç¤ºè¯æ¨¡æ¿: ${data.prompt_template_used}</div>
                    <div>âš¡ çŠ¶æ€: ${data.ragflow_status}</div>
                </div>
            `;
            
            // ç¾åŒ–äººç‰©ä¸»é¡µé“¾æ¥
            const answerTextElement = answerContent.querySelector('.answer-text');
            if (answerTextElement) {
                enhancePersonLinks(answerTextElement);
            }

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯å’Œæ™ºèƒ½æ£€ç´¢çŠ¶æ€
            if (data.debug_info) {
                debugContent.innerHTML = `
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">
${JSON.stringify(data.debug_info, null, 2)}
                    </pre>
                `;
                
                // å¦‚æœæœ‰æ™ºèƒ½æ£€ç´¢ä¿¡æ¯ï¼Œæ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (data.debug_info.smart_retrieval) {
                    const smartInfo = data.debug_info.smart_retrieval;
                    updateSmartRetrievalStatus(smartInfo.question_type, smartInfo.optimized_params);
                }
            }

            // æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
            if (data.performance_stats) {
                const stats = data.performance_stats;
                statsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${(stats.total_time || 0).toFixed(2)}s</div>
                            <div style="color: #666;">æ€»è€—æ—¶</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${(stats.ragflow_time || 0).toFixed(2)}s</div>
                            <div style="color: #666;">RAGflowè€—æ—¶</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${(stats.qwen_time || 0).toFixed(2)}s</div>
                            <div style="color: #666;">Qwenè€—æ—¶</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${data.ragflow_docs_count}</div>
                            <div style="color: #666;">æ–‡æ¡£æ•°é‡</div>
                        </div>
                    </div>
                `;
            }

            // è‡ªåŠ¨åˆ‡æ¢åˆ°ç­”æ¡ˆæ ‡ç­¾é¡µ
            switchTab('answer');
        }

        // æç¤ºè¯ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadPromptTemplates() {
            try {
                const response = await fetch('/prompts');
                const templates = await response.json();
                
                promptTemplates = {};
                const select = document.getElementById('prompt_template');
                select.innerHTML = '';
                
                templates.forEach(template => {
                    promptTemplates[template.name] = template;
                    const option = document.createElement('option');
                    option.value = template.name;
                    option.textContent = template.description || template.name;
                    select.appendChild(option);
                });
                
                updatePromptPreview();
                console.log('æç¤ºè¯æ¨¡æ¿åŠ è½½å®Œæˆ:', templates.length, 'ä¸ªæ¨¡æ¿');
            } catch (error) {
                console.error('åŠ è½½æç¤ºè¯æ¨¡æ¿å¤±è´¥:', error);
            }
        }

        function updatePromptPreview() {
            const selectedTemplate = document.getElementById('prompt_template').value;
            const previewText = document.querySelector('.prompt-preview-text');
            
            if (promptTemplates[selectedTemplate]) {
                previewText.textContent = promptTemplates[selectedTemplate].template;
            } else {
                previewText.textContent = selectedTemplate;
            }
        }

        async function showPromptManager() {
            await loadPromptTemplates();
            renderTemplateList();
            document.getElementById('promptModal').style.display = 'block';
        }

        function closePromptManager() {
            document.getElementById('promptModal').style.display = 'none';
        }

        function renderTemplateList() {
            const templateList = document.getElementById('templateList');
            templateList.innerHTML = '';
            
            Object.values(promptTemplates).forEach(template => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                
                const isDefault = ['default', 'detailed', 'concise', 'analytical'].includes(template.name);
                
                templateItem.innerHTML = `
                    <div class="template-header">
                        <span class="template-name">${template.name}</span>
                        ${isDefault ? '<span class="template-badge">é»˜è®¤</span>' : ''}
                    </div>
                    <div class="template-description">${template.description || 'æš‚æ— æè¿°'}</div>
                    <div class="template-content">${template.template}</div>
                    <div class="template-actions">
                        ${!isDefault ? `
                            <button class="btn-small-action btn-edit" onclick="editTemplate('${template.name}')">âœï¸ ç¼–è¾‘</button>
                            <button class="btn-small-action btn-delete" onclick="deleteTemplate('${template.name}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        ` : ''}
                    </div>
                `;
                
                templateList.appendChild(templateItem);
            });
        }

        async function editTemplate(templateName) {
            const template = promptTemplates[templateName];
            if (!template) return;
            
            const newTemplate = prompt('ç¼–è¾‘æ¨¡æ¿å†…å®¹:', template.template);
            const newDescription = prompt('ç¼–è¾‘æ¨¡æ¿æè¿°:', template.description || '');
            
            if (newTemplate && newTemplate !== template.template) {
                try {
                    const response = await fetch(`/prompts/${templateName}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            template: newTemplate,
                            description: newDescription
                        })
                    });
                    
                    if (response.ok) {
                        await loadPromptTemplates();
                        renderTemplateList();
                        alert('æ¨¡æ¿æ›´æ–°æˆåŠŸï¼');
                    } else {
                        const error = await response.json();
                        alert('æ›´æ–°å¤±è´¥: ' + error.detail);
                    }
                } catch (error) {
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
        }

        async function deleteTemplate(templateName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateName}" å—ï¼Ÿ`)) {
                try {
                    const response = await fetch(`/prompts/${templateName}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await loadPromptTemplates();
                        renderTemplateList();
                        alert('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
                    } else {
                        const error = await response.json();
                        alert('åˆ é™¤å¤±è´¥: ' + error.detail);
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            const datasetIds = document.getElementById('dataset_ids').value.trim();
            
            return {
                question: document.getElementById('question').value.trim(),
                dataset_ids: datasetIds ? datasetIds.split(',').map(id => id.trim()) : [],
                document_ids: [],
                similarity_threshold: parseFloat(document.getElementById('similarity_threshold').value),
                top_k: parseInt(document.getElementById('top_k').value),
                vector_similarity_weight: parseFloat(document.getElementById('vector_similarity_weight').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                prompt_template: document.getElementById('prompt_template').value,
                page_size: parseInt(document.getElementById('top_k').value) || 50,  // ä½¿ç”¨top_kå€¼æˆ–é»˜è®¤50
                keyword: true,
                highlight: true,
                rerank_id: ""
            };
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('qaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = getFormData();
            if (!formData.question) {
                alert('è¯·è¾“å…¥é—®é¢˜ï¼');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/qa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAnswer(data);
                } else {
                    throw new Error(data.detail || 'è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
                console.error('QAè¯·æ±‚å¤±è´¥:', error);
            }

            showLoading(false);
        });

        // è°ƒè¯•åŠŸèƒ½
        async function debugRagflow() {
            const formData = getFormData();
            if (!formData.question) {
                alert('è¯·è¾“å…¥é—®é¢˜ï¼');
                return;
            }

            showLoading(true, 'è°ƒè¯•RAGFlowä¸­...');

            try {
                const response = await fetch('/debug/ragflow', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                document.getElementById('debugContent').innerHTML = `
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">
${JSON.stringify(data, null, 2)}
                    </pre>
                `;
                
                switchTab('debug');
            } catch (error) {
                alert('è°ƒè¯•è¯·æ±‚å¤±è´¥: ' + error.message);
            }

            showLoading(false);
        }

        // æµ‹è¯•æ•°æ®é›†
        async function testDataset() {
            showLoading(true, 'æµ‹è¯•æ•°æ®é›†ä¸­...');
            
            try {
                const datasetId = document.getElementById('dataset_ids').value.trim().split(',')[0];
                const response = await fetch(`/datasets/${datasetId}/test`);
                const data = await response.json();
                
                alert(`æ•°æ®é›†æµ‹è¯•ç»“æœï¼š\nçŠ¶æ€ï¼š${data.status}\næ–‡æ¡£æ•°ï¼š${data.documents_found}\nå“åº”æ—¶é—´ï¼š${data.response_time}ms`);
            } catch (error) {
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
            
            showLoading(false);
        }

        // å¤„ç†æ–°æ¨¡æ¿è¡¨å•æäº¤
        document.getElementById('newTemplateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('newTemplateName').value.trim();
            const description = document.getElementById('newTemplateDescription').value.trim();
            const template = document.getElementById('newTemplateContent').value.trim();
            
            if (!name || !template) {
                alert('è¯·å¡«å†™æ¨¡æ¿åç§°å’Œå†…å®¹ï¼');
                return;
            }
            
            try {
                const response = await fetch('/prompts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        template: template,
                        description: description
                    })
                });
                
                if (response.ok) {
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('newTemplateName').value = '';
                    document.getElementById('newTemplateDescription').value = '';
                    document.getElementById('newTemplateContent').value = '';
                    
                    await loadPromptTemplates();
                    renderTemplateList();
                    alert('æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('åˆ›å»ºå¤±è´¥: ' + error.detail);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        window.onclick = function(event) {
            const modal = document.getElementById('promptModal');
            if (event.target == modal) {
                closePromptManager();
            }
        }

        // å–æ¶ˆæµå¼è¯·æ±‚
        function cancelStreamChat() {
            if (currentStreamController && isStreamActive) {
                try {
                    currentStreamController.abort();
                    console.log('ç”¨æˆ·å–æ¶ˆäº†æµå¼è¯·æ±‚');
                } catch (e) {
                    console.warn('å–æ¶ˆè¯·æ±‚æ—¶å‡ºé”™:', e);
                }
                
                // æ˜¾ç¤ºå–æ¶ˆä¿¡æ¯
                const streamAnswer = document.getElementById('streamAnswer');
                const streamStatus = document.getElementById('streamStatus');
                
                if (streamAnswer) {
                    streamAnswer.innerHTML = `
                        <div style="color: #ffc107; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center;">
                            â¸ï¸ <strong>å·²æš‚åœå›ç­”</strong><br>
                            <small style="margin-top: 8px; display: block;">æ‚¨å·²ä¸»åŠ¨æš‚åœäº†AIå›ç­”ç”Ÿæˆ</small>
                        </div>
                    `;
                }
                
                if (streamStatus) {
                    streamStatus.textContent = 'å·²è¢«ç”¨æˆ·æš‚åœ';
                }
                
                showLoading(false);
            }
        }

        // åˆ†æé—®é¢˜ç±»å‹
        async function analyzeQuestionType(question) {
            try {
                const response = await fetch('/analyze_question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: question})
                });

                if (response.ok) {
                    const data = await response.json();
                    updateSmartRetrievalStatus(data.question_type, data.optimized_params);
                    
                    // æ›´æ–°çŠ¶æ€é¢æ¿æ˜¾ç¤ºæè¿°
                    const statusText = document.getElementById('smartStatusText');
                    statusText.innerHTML += `<br><small>${data.optimization_description}</small>`;
                    
                    console.log('é—®é¢˜åˆ†æç»“æœ:', data);
                } else {
                    console.warn('é—®é¢˜åˆ†æå¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('é—®é¢˜åˆ†æå‡ºé”™:', error);
            }
        }

        // æ™ºèƒ½æ£€ç´¢çŠ¶æ€ç®¡ç†
        function toggleSmartStatus() {
            const details = document.getElementById('smartStatusDetails');
            const isVisible = details.style.display !== 'none';
            details.style.display = isVisible ? 'none' : 'block';
        }

        // å­˜å‚¨å½“å‰ä¼˜åŒ–çš„å‚æ•°ï¼Œç”¨äºåº”ç”¨åˆ°è¡¨å•
        let currentOptimizedParams = null;

        function updateSmartRetrievalStatus(questionType, optimizedParams) {
            const statusPanel = document.getElementById('smartRetrievalStatus');
            const statusText = document.getElementById('smartStatusText');
            const questionTypeSpan = document.getElementById('questionType');
            const thresholdSpan = document.getElementById('optimizedThreshold');
            const topkSpan = document.getElementById('optimizedTopK');
            const weightSpan = document.getElementById('optimizedWeight');
            const applyBtn = document.getElementById('applyParamsBtn');

            // ä¿å­˜ä¼˜åŒ–å‚æ•°ä¾›åç»­ä½¿ç”¨
            currentOptimizedParams = optimizedParams;

            // æ˜¾ç¤ºçŠ¶æ€é¢æ¿
            statusPanel.style.display = 'block';

            // è·å–å½“å‰è¡¨å•å€¼ç”¨äºæ¯”è¾ƒ
            const currentThreshold = parseFloat(document.getElementById('similarity_threshold').value);
            const currentTopK = parseInt(document.getElementById('top_k').value);
            const currentWeight = parseFloat(document.getElementById('vector_similarity_weight').value);

            // æ›´æ–°é—®é¢˜ç±»å‹æè¿°
            const typeDescriptions = {
                'name_query': 'ğŸ” äººåæŸ¥è¯¢ - å…³é”®è¯åŒ¹é…ä¼˜å…ˆ',
                'action_query': 'ğŸ¯ è¡Œä¸ºæŸ¥è¯¢ - è¯­ä¹‰ç†è§£ä¼˜åŒ–',
                'definition_query': 'ğŸ“š å®šä¹‰æŸ¥è¯¢ - å¹³è¡¡æ¨¡å¼',
                'method_query': 'ğŸ› ï¸ æ–¹æ³•æŸ¥è¯¢ - ä¸Šä¸‹æ–‡å¢å¼º',
                'comparison_query': 'âš–ï¸ æ¯”è¾ƒæŸ¥è¯¢ - ç»¼åˆåˆ†æ',
                'general': 'ğŸ“ é€šç”¨æŸ¥è¯¢ - æ ‡å‡†æ¨¡å¼'
            };

            const typeDesc = typeDescriptions[questionType] || questionType;
            questionTypeSpan.textContent = typeDesc;
            thresholdSpan.textContent = optimizedParams.similarity_threshold?.toFixed(3) || '-';
            topkSpan.textContent = optimizedParams.top_k || '-';
            weightSpan.textContent = optimizedParams.vector_similarity_weight?.toFixed(2) || '-';

            // æ˜¾ç¤ºå‚æ•°å˜åŒ–ä¿¡æ¯
            const thresholdChange = document.getElementById('thresholdChange');
            const topkChange = document.getElementById('topkChange');
            const weightChange = document.getElementById('weightChange');

            let hasChanges = false;

            if (optimizedParams.similarity_threshold && Math.abs(optimizedParams.similarity_threshold - currentThreshold) > 0.001) {
                const change = optimizedParams.similarity_threshold - currentThreshold;
                thresholdChange.textContent = `(${change > 0 ? '+' : ''}${change.toFixed(3)})`;
                thresholdChange.style.color = change > 0 ? '#28a745' : '#dc3545';
                hasChanges = true;
            } else {
                thresholdChange.textContent = '';
            }

            if (optimizedParams.top_k && optimizedParams.top_k !== currentTopK) {
                const change = optimizedParams.top_k - currentTopK;
                topkChange.textContent = `(${change > 0 ? '+' : ''}${change})`;
                topkChange.style.color = change > 0 ? '#28a745' : '#dc3545';
                hasChanges = true;
            } else {
                topkChange.textContent = '';
            }

            if (optimizedParams.vector_similarity_weight && Math.abs(optimizedParams.vector_similarity_weight - currentWeight) > 0.01) {
                const change = optimizedParams.vector_similarity_weight - currentWeight;
                weightChange.textContent = `(${change > 0 ? '+' : ''}${change.toFixed(2)})`;
                weightChange.style.color = change > 0 ? '#28a745' : '#dc3545';
                hasChanges = true;
            } else {
                weightChange.textContent = '';
            }

            // æ ¹æ®æ˜¯å¦æœ‰å‚æ•°å˜åŒ–å†³å®šæ˜¯å¦æ˜¾ç¤ºåº”ç”¨æŒ‰é’®
            if (hasChanges) {
                applyBtn.style.display = 'inline-block';
                applyBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                applyBtn.style.color = 'white';
            } else {
                applyBtn.style.display = 'none';
            }

            // æ›´æ–°çŠ¶æ€æ‘˜è¦
            if (questionType === 'action_query') {
                statusText.innerHTML = 'âœ¨ <strong>å·²ä¸º"åšäº†ä»€ä¹ˆ"ç±»é—®é¢˜ä¼˜åŒ–æ£€ç´¢å‚æ•°</strong> - æå‡è¯­ä¹‰ç†è§£èƒ½åŠ›';
                statusText.style.color = '#28a745';
            } else if (questionType === 'name_query') {
                statusText.innerHTML = 'ğŸ¯ <strong>å·²ä¸ºäººåæŸ¥è¯¢ä¼˜åŒ–å‚æ•°</strong> - æå‡å…³é”®è¯åŒ¹é…ç²¾åº¦';
                statusText.style.color = '#007bff';
            } else {
                statusText.innerHTML = `ğŸ¤– <strong>æ™ºèƒ½æ£€ç´¢å·²æ¿€æ´»</strong> - é’ˆå¯¹${typeDesc}ä¼˜åŒ–`;
                statusText.style.color = '#667eea';
            }

            // å¦‚æœæœ‰å˜åŒ–ï¼Œæ·»åŠ æç¤ºä¿¡æ¯
            if (hasChanges) {
                statusText.innerHTML += '<br><small style="color: #ffc107;">âš¡ æ£€æµ‹åˆ°å‚æ•°ä¼˜åŒ–ï¼Œç‚¹å‡»"åº”ç”¨ä¼˜åŒ–"æŒ‰é’®åŒæ­¥åˆ°é…ç½®</small>';
            }
        }

        // åº”ç”¨ä¼˜åŒ–å‚æ•°åˆ°è¡¨å•
        function applyOptimizedParams() {
            if (!currentOptimizedParams) {
                alert('æš‚æ— ä¼˜åŒ–å‚æ•°å¯åº”ç”¨');
                return;
            }

            const confirmMsg = 'ç¡®å®šè¦å°†æ™ºèƒ½ä¼˜åŒ–çš„å‚æ•°åº”ç”¨åˆ°å½“å‰é…ç½®å—ï¼Ÿ\n\nè¿™å°†æ›´æ–°ï¼š\n';
            let changes = [];
            
            if (currentOptimizedParams.similarity_threshold) {
                changes.push(`â€¢ ç›¸ä¼¼åº¦é˜ˆå€¼: ${currentOptimizedParams.similarity_threshold.toFixed(3)}`);
            }
            if (currentOptimizedParams.top_k) {
                changes.push(`â€¢ æ£€ç´¢æ–‡æ¡£æ•°: ${currentOptimizedParams.top_k}`);
            }
            if (currentOptimizedParams.vector_similarity_weight) {
                changes.push(`â€¢ å‘é‡æƒé‡: ${currentOptimizedParams.vector_similarity_weight.toFixed(2)}`);
            }

            if (confirm(confirmMsg + changes.join('\n'))) {
                // åº”ç”¨ä¼˜åŒ–å‚æ•°
                if (currentOptimizedParams.similarity_threshold) {
                    document.getElementById('similarity_threshold').value = currentOptimizedParams.similarity_threshold.toFixed(3);
                    animateInputChange('similarity_threshold');
                }
                if (currentOptimizedParams.top_k) {
                    document.getElementById('top_k').value = currentOptimizedParams.top_k;
                    animateInputChange('top_k');
                }
                if (currentOptimizedParams.vector_similarity_weight) {
                    document.getElementById('vector_similarity_weight').value = currentOptimizedParams.vector_similarity_weight.toFixed(1);
                    animateInputChange('vector_similarity_weight');
                }

                // éšè—åº”ç”¨æŒ‰é’®å¹¶æ›´æ–°çŠ¶æ€
                document.getElementById('applyParamsBtn').style.display = 'none';
                
                // æ¸…é™¤å˜åŒ–æç¤º
                document.getElementById('thresholdChange').textContent = '';
                document.getElementById('topkChange').textContent = '';
                document.getElementById('weightChange').textContent = '';

                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                const statusText = document.getElementById('smartStatusText');
                statusText.innerHTML += '<br><small style="color: #28a745;">âœ… ä¼˜åŒ–å‚æ•°å·²åº”ç”¨åˆ°é…ç½®</small>';

                alert('âœ… ä¼˜åŒ–å‚æ•°å·²æˆåŠŸåº”ç”¨åˆ°é…ç½®ï¼');
            }
        }

        // è¾“å…¥æ¡†å˜åŒ–åŠ¨ç”»æ•ˆæœ
        function animateInputChange(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                // æ·»åŠ ä¼˜åŒ–æ ·å¼ç±»
                input.classList.add('param-optimized');
                
                // 2ç§’åç§»é™¤æ ·å¼ç±»
                setTimeout(() => {
                    input.classList.remove('param-optimized');
                }, 2000);
            }
        }

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                document.getElementById('qaForm').dispatchEvent(new Event('submit'));
            }
            
            // ESCé”®å–æ¶ˆæµå¼è¯·æ±‚
            if (e.key === 'Escape' && isStreamActive) {
                cancelStreamChat();
            }
        });

        // æµå¼é—®ç­”åŠŸèƒ½
        async function startStreamChat() {
            const formData = getFormData();
            if (!formData.question) {
                alert('è¯·è¾“å…¥é—®é¢˜ï¼');
                return;
            }

            // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
            currentStreamController = new AbortController();
            isStreamActive = true;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
            showLoading(true, 'å‡†å¤‡æµå¼ç”Ÿæˆ...', true);

            // æ¸…ç©ºå¹¶å‡†å¤‡ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ
            const answerContent = document.getElementById('answerContent');
            answerContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #667eea;">âš¡ AIå®æ—¶å›ç­”ï¼š</strong>
                    <span id="streamStatus" style="margin-left: 10px; font-size: 12px; color: #666;">æ­£åœ¨æ£€ç´¢æ–‡æ¡£...</span>
                </div>
                <div id="streamAnswer" class="answer-text" style="min-height: 100px; background: #f8f9fa; border-radius: 10px; padding: 15px;">
                    <div id="streamCursor" style="display: inline-block; width: 2px; height: 20px; background: #667eea; animation: blink 1s infinite;"></div>
                </div>
                <div id="streamStats" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                    <div>ğŸ“Š æ£€ç´¢çŠ¶æ€: <span id="retrievalStatus">å‡†å¤‡ä¸­...</span></div>
                    <div>ğŸ“ ä¸Šä¸‹æ–‡çŠ¶æ€: <span id="contextStatus">å‡†å¤‡ä¸­...</span></div>
                    <div>â±ï¸ ç”Ÿæˆæ—¶é—´: <span id="generationTime">0s</span></div>
                </div>
            `;

            // åˆ‡æ¢åˆ°ç­”æ¡ˆæ ‡ç­¾é¡µ
            switchTab('answer');

            try {
                // ä½¿ç”¨fetchè¿›è¡Œæµå¼è¯·æ±‚ï¼ˆæ”¯æŒå–æ¶ˆï¼‰
                const response = await fetch('/qa/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify(formData),
                    signal: currentStreamController.signal  // æ·»åŠ å–æ¶ˆä¿¡å·
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                const streamAnswer = document.getElementById('streamAnswer');
                const streamStatus = document.getElementById('streamStatus');
                const retrievalStatus = document.getElementById('retrievalStatus');
                const contextStatus = document.getElementById('contextStatus');
                const generationTime = document.getElementById('generationTime');

                let fullContent = '';
                let startTime = Date.now();
                let buffer = '';

                // å¤„ç†æµå¼å“åº”
                const processStream = async () => {
                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // æŒ‰è¡Œåˆ†å‰²æ•°æ®
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // ä¿ç•™æœ€åä¸€è¡Œå¯èƒ½ä¸å®Œæ•´çš„æ•°æ®

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                
                                let eventData = line;
                                if (line.startsWith('data: ')) {
                                    eventData = line.substring(6);
                                }

                                if (eventData === '[DONE]') {
                                    showLoading(false);
                                    return;
                                }

                                try {
                                    const data = JSON.parse(eventData);
                                    const currentTime = ((Date.now() - startTime) / 1000).toFixed(1);
                                    generationTime.textContent = currentTime + 's';

                                    switch (data.type) {
                                        case 'retrieval_complete':
                                            streamStatus.textContent = `æ£€ç´¢å®Œæˆï¼Œæ‰¾åˆ°${data.documents_found}ä¸ªç›¸å…³æ–‡æ¡£`;
                                            retrievalStatus.textContent = `å®Œæˆ (${data.documents_found}ä¸ªæ–‡æ¡£, ${data.time?.toFixed(2)}s)`;
                                            break;

                                        case 'context_ready':
                                            streamStatus.textContent = `ä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆï¼Œå¼€å§‹AIç”Ÿæˆ...`;
                                            contextStatus.textContent = `å®Œæˆ (ä½¿ç”¨${data.documents_used}ä¸ªæ–‡æ¡£)`;
                                            // æ¸…é™¤å…‰æ ‡ï¼Œå¼€å§‹æ˜¾ç¤ºå†…å®¹
                                            streamAnswer.innerHTML = '';
                                            break;

                                        case 'content':
                                            // å®æ—¶è¿½åŠ å†…å®¹
                                            fullContent += data.content;
                                            const processedContent = formatAnswerWithLinks(fullContent);
                                            streamAnswer.innerHTML = processedContent + '<div id="streamCursor" style="display: inline-block; width: 2px; height: 20px; background: #667eea; animation: blink 1s infinite; margin-left: 2px;"></div>';
                                            
                                            // ç¾åŒ–äººç‰©ä¸»é¡µé“¾æ¥ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
                                            enhancePersonLinks(streamAnswer);
                                            
                                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                            const rightPanel = streamAnswer.closest('.right-panel');
                                            if (rightPanel) {
                                                rightPanel.scrollTop = rightPanel.scrollHeight;
                                            }
                                            break;

                                        case 'complete':
                                            streamStatus.textContent = `ç”Ÿæˆå®Œæˆï¼`;
                                            // ç§»é™¤å…‰æ ‡
                                            const finalCursor = document.getElementById('streamCursor');
                                            if (finalCursor) {
                                                finalCursor.remove();
                                            }
                                            
                                            // æ˜¾ç¤ºæœ€ç»ˆå†…å®¹ï¼ˆåŒ…å«äººç‰©é“¾æ¥ï¼‰
                                            const finalContent = data.full_content || fullContent;
                                            streamAnswer.innerHTML = formatAnswerWithLinks(finalContent);
                                            
                                            // ç¾åŒ–æœ€ç»ˆç­”æ¡ˆä¸­çš„äººç‰©ä¸»é¡µé“¾æ¥
                                            enhancePersonLinks(streamAnswer);
                                            
                                            console.log('æµå¼ç”Ÿæˆå®Œæˆï¼Œå·²å¤„ç†äººç‰©é“¾æ¥');
                                            
                                            // æ·»åŠ å®Œæˆä¿¡æ¯
                                            streamAnswer.insertAdjacentHTML('beforeend', `
                                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666;">
                                                    <div>âœ… ç”Ÿæˆå®Œæˆ</div>
                                                    <div>ğŸ“Š ä½¿ç”¨ä¸Šä¸‹æ–‡: ${data.context_used ? 'æ˜¯' : 'å¦'}</div>
                                                    <div>â±ï¸ æ€»è€—æ—¶: ${data.total_time?.toFixed(2)}s</div>
                                                </div>
                                            `);
                                            
                                            showLoading(false);
                                            return;

                                        case 'cancelled':
                                            streamStatus.textContent = 'ç”Ÿæˆå·²å–æ¶ˆ';
                                            streamAnswer.innerHTML = `
                                                <div style="color: #6c757d; padding: 15px; background: #e2e3e5; border-radius: 8px; text-align: center;">
                                                    â¸ï¸ <strong>ç”Ÿæˆå·²æš‚åœ</strong><br>
                                                    <small style="margin-top: 8px; display: block;">${data.message || 'è¯·æ±‚å·²è¢«å–æ¶ˆ'}</small>
                                                </div>
                                            `;
                                            showLoading(false);
                                            return;

                                        case 'error':
                                            streamStatus.textContent = 'ç”Ÿæˆå‡ºé”™';
                                            streamAnswer.innerHTML = `
                                                <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px;">
                                                    âŒ é”™è¯¯: ${data.message}
                                                </div>
                                            `;
                                            showLoading(false);
                                            return;
                                    }
                                } catch (parseError) {
                                    console.warn('è§£ææµå¼æ•°æ®å¤±è´¥:', parseError, 'Data:', eventData);
                                }
                            }
                        }
                                                } catch (streamError) {
                                if (streamError.name === 'AbortError') {
                                    console.log('æµå¼è¯·æ±‚å·²è¢«ç”¨æˆ·å–æ¶ˆ');
                                    return; // å–æ¶ˆæ—¶ä¸æ˜¾ç¤ºé”™è¯¯
                                }
                                
                                console.error('æµå¼å¤„ç†é”™è¯¯:', streamError);
                                streamStatus.textContent = 'æ•°æ®å¤„ç†å‡ºé”™';
                                streamAnswer.innerHTML = `
                                    <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px;">
                                        âŒ æ•°æ®æµå¤„ç†å‡ºé”™: ${streamError.message}
                                    </div>
                                `;
                                showLoading(false);
                            }
                };

                // å¼€å§‹å¤„ç†æµ
                processStream();

                // è®¾ç½®è¶…æ—¶å¤„ç† - ä½¿ç”¨åç«¯é…ç½®çš„è¶…æ—¶æ—¶é—´
                setTimeout(() => {
                    try {
                        reader.cancel();
                    } catch (e) {}
                    showLoading(false);
                    streamStatus.textContent = 'è¯·æ±‚è¶…æ—¶';
                    streamAnswer.innerHTML = `
                        <div style="color: #ffc107; padding: 15px; background: #fff3cd; border-radius: 8px;">
                            âš ï¸ è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨ä¸²è¡Œå›ç­”æ¨¡å¼<br>
                            <small style="margin-top: 8px; display: block;">å¦‚æœé—®é¢˜å¤æ‚ï¼Œå»ºè®®å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä½¿ç”¨æ™®é€šé—®ç­”æ¨¡å¼</small>
                        </div>
                    `;
                }, streamTimeoutMs); // åŠ¨æ€è¶…æ—¶é…ç½®

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('æµå¼è¯·æ±‚å·²è¢«ç”¨æˆ·å–æ¶ˆ');
                    // ç”¨æˆ·å–æ¶ˆæ—¶ä¸æ˜¾ç¤ºé”™è¯¯æç¤º
                    return;
                }
                
                console.error('æµå¼è¯·æ±‚å¤±è´¥:', error);
                showLoading(false);
                
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                const answerContent = document.getElementById('answerContent');
                answerContent.innerHTML = `
                    <div class="answer-content">
                        <div style="color: #dc3545; padding: 20px; background: #f8d7da; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                            <strong>å¯åŠ¨æµå¼é—®ç­”å¤±è´¥</strong><br>
                            <small style="margin-top: 8px; display: block; color: #721c24;">
                                ${error.message || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€åé‡è¯•'}
                            </small>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()" style="font-size: 12px; padding: 8px 16px;">
                                    ğŸ”„ åˆ·æ–°é¡µé¢
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 
</html> 